<div class="mx-auto max-w-5xl px-4 py-8">
  @if (isLoading()) {
    <div class="flex items-center justify-center py-12">
      <p class="text-gray-500">Loading...</p>
    </div>
  } @else if (course()) {
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-gray-900">Edit Course</h1>
      <div class="flex gap-2">
        <button
          (click)="publishCourse()"
          class="rounded-md bg-green-600 px-4 py-2 text-white hover:bg-green-700"
        >
          Publish Course
        </button>
        <a
          [routerLink]="['/courses', course()!.id]"
          class="rounded-md border border-gray-300 bg-white px-4 py-2 text-gray-700 hover:bg-gray-50"
        >
          View Course
        </a>
      </div>
    </div>

    <!-- Messages -->
    @if (successMessage()) {
      <div class="mb-6 rounded-md bg-green-50 p-4">
        <p class="text-sm text-green-800">{{ successMessage() }}</p>
      </div>
    }
    @if (errorMessage()) {
      <div class="mb-6 rounded-md bg-red-50 p-4">
        <p class="text-sm text-red-800">{{ errorMessage() }}</p>
      </div>
    }

    <!-- Course Info Section -->
    <div class="mb-8 rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-900">Course Information</h2>
        @if (!isEditingCourse()) {
          <button
            (click)="toggleEditCourse()"
            class="rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
          >
            Edit Info
          </button>
        }
      </div>

      @if (isEditingCourse()) {
        <form [formGroup]="courseForm" (ngSubmit)="saveCourse()">
          <div class="mb-4">
            <label for="title" class="mb-1 block text-sm font-medium text-gray-700">Title</label>
            <input
              id="title"
              type="text"
              formControlName="title"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
            @if (courseForm.get('title')?.invalid && courseForm.get('title')?.touched) {
              <p class="mt-1 text-sm text-red-600">Title must be at least 3 characters</p>
            }
          </div>

          <div class="mb-4">
            <label for="description" class="mb-1 block text-sm font-medium text-gray-700">Description</label>
            <textarea
              id="description"
              formControlName="description"
              rows="4"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            ></textarea>
            @if (courseForm.get('description')?.invalid && courseForm.get('description')?.touched) {
              <p class="mt-1 text-sm text-red-600">Description must be at least 10 characters</p>
            }
          </div>

          <div class="flex gap-2">
            <button
              type="submit"
              class="rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
            >
              Save Changes
            </button>
            <button
              type="button"
              (click)="toggleEditCourse()"
              class="rounded-md border border-gray-300 bg-white px-4 py-2 text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
          </div>
        </form>
      } @else {
        <div>
          <h3 class="mb-2 text-lg font-semibold text-gray-900">{{ course()!.title }}</h3>
          <div class="text-gray-700 markdown-content" [innerHTML]="renderDescription(course()!.description)"></div>
        </div>
      }
    </div>

    <!-- Chapters Section -->
    <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-900">Course Structure</h2>
        @if (!isAddingChapter()) {
          <button
            (click)="toggleAddChapter()"
            class="rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
          >
            + Add Chapter
          </button>
        }
      </div>

      <!-- Add Chapter Form -->
      @if (isAddingChapter()) {
        <form [formGroup]="chapterForm" (ngSubmit)="addChapter()" class="mb-6 rounded-md bg-gray-50 p-4">
          <div class="mb-3">
            <label for="chapterTitle" class="mb-1 block text-sm font-medium text-gray-700">
              Chapter Title
            </label>
            <input
              id="chapterTitle"
              type="text"
              formControlName="title"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="e.g., Getting Started"
            />
            @if (chapterForm.get('title')?.invalid && chapterForm.get('title')?.touched) {
              <p class="mt-1 text-sm text-red-600">Chapter title must be at least 3 characters</p>
            }
          </div>
          <div class="flex gap-2">
            <button
              type="submit"
              class="rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
            >
              Add Chapter
            </button>
            <button
              type="button"
              (click)="toggleAddChapter()"
              class="rounded-md border border-gray-300 bg-white px-4 py-2 text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
          </div>
        </form>
      }

      <!-- Chapters List -->
      @if (chapters().length === 0) {
        <div class="rounded-md bg-gray-50 p-8 text-center">
          <p class="text-gray-500">
            No chapters yet. Click "Add Chapter" to create your first chapter.
          </p>
        </div>
      } @else {
        <div class="space-y-3">
          @for (chapter of chapters(); track chapter.id) {
            <div class="rounded-md border border-gray-200 bg-gray-50 p-4">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h3 class="font-semibold text-gray-900">
                    {{ chapter.orderIndex }}. {{ chapter.title }}
                  </h3>
                  <p class="mt-1 text-sm text-gray-600">
                    {{ chapter.subchaptersCount }} subchapter(s)
                  </p>
                </div>
                <div class="flex gap-2">
                  <button
                    (click)="moveChapterUp(chapter.id, chapter.orderIndex)"
                    [disabled]="chapter.orderIndex === 1"
                    [class.opacity-50]="chapter.orderIndex === 1"
                    [class.cursor-not-allowed]="chapter.orderIndex === 1"
                    class="rounded-md bg-gray-600 px-3 py-1 text-sm text-white hover:bg-gray-700 disabled:hover:bg-gray-600"
                    title="Move up"
                  >
                    â†‘
                  </button>
                  <button
                    (click)="moveChapterDown(chapter.id, chapter.orderIndex)"
                    [disabled]="chapter.orderIndex === chapters().length"
                    [class.opacity-50]="chapter.orderIndex === chapters().length"
                    [class.cursor-not-allowed]="chapter.orderIndex === chapters().length"
                    class="rounded-md bg-gray-600 px-3 py-1 text-sm text-white hover:bg-gray-700 disabled:hover:bg-gray-600"
                    title="Move down"
                  >
                    â†“
                  </button>
                  <a
                    [routerLink]="['/courses', course()!.id, 'chapters', chapter.id, 'edit']"
                    class="rounded-md bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"
                  >
                    Manage
                  </a>
                  <button
                    (click)="deleteChapter(chapter.id)"
                    class="rounded-md border border-red-300 bg-white px-3 py-1 text-sm text-red-700 hover:bg-red-50"
                  >
                    Delete
                  </button>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Info Box -->
    <div class="mt-6 rounded-md bg-blue-50 p-4">
      <p class="text-sm text-blue-800">
        ðŸ’¡ <strong>Next steps:</strong> Add chapters to organize your course content. 
        Each chapter can contain multiple subchapters, and each subchapter can have learning blocks 
        (theory, videos, quizzes, and coding problems).
      </p>
    </div>
  }
</div>
